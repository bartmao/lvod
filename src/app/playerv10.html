<html>

<head>
    <script src="js/jquery-2.0.0.min.js"></script>
    <script src="js/socket.io.min.js"></script>
</head>

<body>
    <button id='live' onclick="start()">play</button><br/>
    <button id='click' onclick="update()">click</button><br/>
    <canvas width="200" height="200"></canvas>
    <img width="200" height="200" src=''></img>
    <div id='info'></div>
    <div id='output'></div>
    <script>
        var c = document.getElementsByTagName('canvas')[0];
        var ctx = c.getContext('2d');
        var timeShift = 1000;
        var frames = [];
        var startTime;
        var diff;
        var size = 0;

        function start() {
            write('start');
            update();
            this._socket = io.connect('http://192.168.1.106:8000');
            this._socket.on('receiveFrames', function (group) {
                group.frames.reduce(function (acc, f) {
                    size += f.data.length;
                });
                document.getElementById('info').innerHTML = size;
                frames = frames.concat(group.frames);
                console.log(group.frames);
                write('new frames');
            });
        }

        function update() {
            if (frames.length > 0) {
                var ts = +new Date();
                var frame = frames[0];
                if (!startTime) {
                    startTime = new Date(frame.ts);
                    diff = ts - startTime;
                }

                var mydiff = ts - diff - timeShift - new Date(frame.ts);
                if (ts - diff - timeShift >= new Date(frame.ts)) {
                    console.log(mydiff + 'ms');
                    var image = new Image();
                    image.src = frame.data;
                    image.onload = () => ctx.drawImage(image, 0, 0);

                    frames.shift();
                }
            }
            requestAnimationFrame(this.update.bind(this));
        }

        function write(msg) {
            var div = document.getElementById('output');
            if (div.innerHTML.length > 1000) div.innerHTML = '';
            div.innerHTML = new Date() + msg + '<br/>' + div.innerHTML;
        }
    </script>
</body>

</html>